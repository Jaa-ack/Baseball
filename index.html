<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <link rel="manifest" href="manifest.json">
  <link rel="apple-touch-icon" href="icons/icon-192.png">
  <title>棒球比賽紀錄器 PWA</title>
  <style>
    :root{
      --bg:#1B3B2A;
      --panel:#2C2C29;
      --text:#F9F9F4;
      --btn:#D0D3D4;
      --btnfg:#111;
      --btnactive:#B5BABB;
      --off:#4A4A42;
      --s-on:#FFEB3B;
      --b-on:#6BE870;
      --o-on:#FF6E6E;
      --tbl:#3a3a36;
    }
    html,body{margin:0;padding:0;background:var(--bg);color:var(--text);
      font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans",sans-serif;}
    .wrap{max-width:980px;margin:0 auto;padding:12px;}
    .panel{background:var(--panel);border-radius:14px;padding:12px;
      box-shadow:0 6px 20px rgba(0,0,0,.25);}
    .row{display:flex;align-items:center;gap:10px;flex-wrap:wrap;}
    .topbar{justify-content:space-between}
    h1{font-size:20px;margin:0}
    .btn{background:var(--btn);color:var(--btnfg);border:none;border-radius:10px;
      padding:10px 12px;font-weight:600;cursor:pointer}
    .btn:active{background:var(--btnactive)}
    .grid{display:grid;gap:10px}
    .scorebox{border:1px solid #6A6F68;border-radius:10px;padding:10px 12px}
    .lights-row{display:flex;align-items:center;gap:8px;margin:8px 0}
    .light{width:26px;height:26px;border-radius:50%;background:var(--off);}
    .light.clear{outline:2px dashed #666;outline-offset:3px;display:none;}
    .label{font-weight:700;width:22px;text-align:center}
    .bases{position:relative;width:240px;height:200px;background:var(--panel)}
    .base{position:absolute;width:16px;height:16px;background:var(--off)}
    .b1{left:190px;top:100px}
    .b2{left:120px;top:30px}
    .b3{left:50px;top:100px}
    .home{position:absolute;left:120px;top:170px;width:24px;height:18px;background:white;
      clip-path:polygon(50% 100%, 0 0, 100% 0)}
    .pitch{font-size:18px;font-weight:800}
    .endbanner{color:var(--o-on);font-weight:900;font-size:18px;text-align:center;min-height:26px}
    .hidden{display:none!important;}
    .scoretbl{width:100%;border-collapse:collapse}
    .scoretbl th,.scoretbl td{padding:8px 6px}
    .scoretbl .points{font-size:22px;font-weight:900;color:var(--b-on)}
    .actions-rows{display:grid;gap:12px}
    .actions-rows .line{display:flex;gap:10px}
    .btn.circle{width:64px;height:64px;border-radius:50%;font-size:16px;font-weight:800}
    .btn.square{border-radius:12px;min-width:120px}
    .logbox{max-height:320px;overflow:auto;border:1px solid var(--tbl);border-radius:12px}
    .logtbl{width:100%;border-collapse:collapse;border:1px solid var(--tbl)}
    .logtbl th,.logtbl td{border-bottom:1px solid var(--tbl);padding:8px 10px;text-align:center}
    .setup{position:fixed;inset:0;background:rgba(0,0,0,.6);display:flex;
      align-items:center;justify-content:center;z-index:50;}
    .setup .card{width:min(680px,92vw);background:var(--panel);border-radius:16px;
      padding:18px;box-shadow:0 10px 30px rgba(0,0,0,.5)}
  </style>
</head>
<body>
<div class="wrap">
  <div class="panel">
    <div class="row topbar">
      <div>
        <h1 id="banner"></h1>
        <div id="info" class="info"></div>
      </div>
      <div class="row" style="gap:8px">
        <button id="btnReset" class="btn muted">重新設定</button>
        <button id="btnEdit" class="btn">編輯</button>
      </div>
    </div>

    <div class="row" style="margin-top:10px;gap:20px">
      <div>
        <div class="lights-row" id="rowS">
          <div class="light clear" id="clearS" title="清空好球"></div>
          <div class="label">S</div>
          <div class="light" data-s="1"></div>
          <div class="light" data-s="2"></div>
        </div>
        <div class="lights-row" id="rowB">
          <div class="light clear" id="clearB" title="清空壞球"></div>
          <div class="label">B</div>
          <div class="light" data-b="1"></div>
          <div class="light" data-b="2"></div>
          <div class="light" data-b="3"></div>
        </div>
        <div class="lights-row" id="rowO">
          <div class="light clear" id="clearO" title="清空出局燈"></div>
          <div class="label">O</div>
          <div class="light" data-o="1"></div>
          <div class="light" data-o="2"></div>
        </div>
      </div>
      <div class="bases panel">
        <div class="base b1" id="b1"></div>
        <div class="base b2" id="b2"></div>
        <div class="base b3" id="b3"></div>
        <div class="home"></div>
      </div>
    </div>

    <div class="row" style="margin-top:8px;justify-content:space-between">
      <div class="pitchbox">
        <div id="pitch" class="pitch mono"></div>
        <button id="pMinus" class="btn hidden">-</button>
        <button id="pPlus" class="btn hidden">+</button>
      </div>
      <div style="min-width:260px" class="scorebox">
        <div id="gameover" class="endbanner"></div>
        <table class="scoretbl">
          <thead><tr><th>隊伍</th><th>分數</th></tr></thead>
          <tbody>
            <tr><td id="teamA"></td><td id="scoreA" class="points">0</td></tr>
            <tr><td id="teamB"></td><td id="scoreB" class="points">0</td></tr>
          </tbody>
        </table>
        <div id="scoreAdjust" class="row hidden" style="margin-top:6px">
          <button id="sMinus" class="btn">-</button>
          <button id="sPlus"  class="btn">+</button>
        </div>
      </div>
    </div>

    <div class="panel" style="margin-top:12px">
      <div class="actions-rows">
        <div class="line">
          <button class="btn circle act" data-act="strike">好球</button>
          <button class="btn circle act" data-act="ball">壞球</button>
        </div>
        <div class="line">
          <button class="btn square act" data-act="ground">滾地球</button>
          <button class="btn square act" data-act="fly">高飛球</button>
          <button class="btn square act" data-act="foul">界外球</button>
        </div>
        <div class="line">
          <button class="btn square act" data-act="hit-1">一壘安打</button>
          <button class="btn square act" data-act="hit-2">二壘安打</button>
          <button class="btn square act" data-act="hit-3">三壘安打</button>
          <button class="btn square act" data-act="hit-4">全壘打</button>
          <button class="btn square act" data-act="grd">場地規則</button>
        </div>
        <div class="line">
          <button class="btn square act" data-act="hbp">觸身球</button>
          <button class="btn square act" data-act="wp">暴投</button>
          <button class="btn square act" data-act="err">失誤</button>
          <button class="btn square act" data-act="bunt">短打成功</button>
        </div>
      </div>
    </div>

    <div class="logwrap">
      <div class="loghead">
        <h3 style="margin:0">逐球紀錄</h3>
        <div class="row">
          <button id="btnUndo" class="btn">↩︎ 復原上一步</button>
        </div>
      </div>
      <div class="logbox">
        <table class="logtbl" id="logTable">
          <thead>
            <tr>
              <th class="inning">局數</th>
              <th id="thTeamL">（左）投手</th>
              <th id="thTeamR">（右）投手</th>
              <th class="score">比分</th>
            </tr>
          </thead>
          <tbody id="logBody"></tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<!-- 賽前設定 -->
<div id="setup" class="setup hidden">
  <div class="card">
    <h2>賽前設定</h2>
    <p class="subtle">請輸入兩隊名稱並指定左側為先攻、右側為先守。</p>
    <div class="teams-flex">
      <div class="teamcard">
        <h4>左：先攻隊伍</h4>
        <div class="fld"><input id="inTeamOff" placeholder="先攻隊伍"></div>
      </div>
      <div class="teamcard">
        <h4>右：先守隊伍</h4>
        <div class="fld"><input id="inTeamDef" placeholder="先守隊伍"></div>
      </div>
    </div>
    <div class="actbar"><button id="btnSetupStart" class="btn">開始比賽</button></div>
  </div>
</div>

<script>
(function(){
  const S_ON=getComputedStyle(document.documentElement).getPropertyValue('--s-on').trim();
  const B_ON=getComputedStyle(document.documentElement).getPropertyValue('--b-on').trim();
  const O_ON=getComputedStyle(document.documentElement).getPropertyValue('--o-on').trim();
  const OFF =getComputedStyle(document.documentElement).getPropertyValue('--off').trim();

  const state={
    teamL: localStorage.getItem('teamL')||'先攻隊伍',
    teamR: localStorage.getItem('teamR')||'先守隊伍',
    inning: parseInt(localStorage.getItem('inning')||'1',10),
    top: (localStorage.getItem('top')||'1')==='1',
    strike:0,ball:0,out:0,
    pitch_team:{},
    score:{},
    bases:[false,false,false],
    edit_mode:false,game_over:false,
    logs: JSON.parse(localStorage.getItem('logs')||'{"timeline":[]}'),
  };

  const el={
    banner:document.getElementById('banner'),
    info:document.getElementById('info'),
    btnEdit:document.getElementById('btnEdit'),
    btnReset:document.getElementById('btnReset'),
    rowS:document.getElementById('rowS'),
    rowB:document.getElementById('rowB'),
    rowO:document.getElementById('rowO'),
    b1:document.getElementById('b1'),
    b2:document.getElementById('b2'),
    b3:document.getElementById('b3'),
    pitch:document.getElementById('pitch'),
    pMinus:document.getElementById('pMinus'),
    pPlus:document.getElementById('pPlus'),
    teamA:document.getElementById('teamA'),
    teamB:document.getElementById('teamB'),
    scoreA:document.getElementById('scoreA'),
    scoreB:document.getElementById('scoreB'),
    gameover:document.getElementById('gameover'),
    scoreAdjust:document.getElementById('scoreAdjust'),
    sMinus:document.getElementById('sMinus'),
    sPlus:document.getElementById('sPlus'),
    setup:document.getElementById('setup'),
    inTeamOff:document.getElementById('inTeamOff'),
    inTeamDef:document.getElementById('inTeamDef'),
    btnSetupStart:document.getElementById('btnSetupStart'),
    thTeamL:document.getElementById('thTeamL'),
    thTeamR:document.getElementById('thTeamR'),
    logBody:document.getElementById('logBody'),
    btnUndo:document.getElementById('btnUndo'),
  };

  // 初始化分數與投球數
  const L=state.teamL, R=state.teamR;
  state.pitch_team[L]=parseInt(localStorage.getItem('pitch_'+L)||'0',10);
  state.pitch_team[R]=parseInt(localStorage.getItem('pitch_'+R)||'0',10);
  state.score[L]=parseInt(localStorage.getItem('score_'+L)||'0',10);
  state.score[R]=parseInt(localStorage.getItem('score_'+R)||'0',10);

  if(!localStorage.getItem('teamL')||!localStorage.getItem('teamR')) openSetup();

  el.teamA.textContent=state.teamL;
  el.teamB.textContent=state.teamR;
  el.thTeamL.textContent=state.teamL+'（投手）';
  el.thTeamR.textContent=state.teamR+'（投手）';

  /* ====== 儲存/工具 ====== */
  function saveBasics(){
    localStorage.setItem('teamL',state.teamL);
    localStorage.setItem('teamR',state.teamR);
    localStorage.setItem('pitch_'+state.teamL,state.pitch_team[state.teamL]||0);
    localStorage.setItem('pitch_'+state.teamR,state.pitch_team[state.teamR]||0);
    localStorage.setItem('score_'+state.teamL,state.score[state.teamL]||0);
    localStorage.setItem('score_'+state.teamR,state.score[state.teamR]||0);
    localStorage.setItem('inning',state.inning);
    localStorage.setItem('top',state.top?'1':'0');
  }
  function saveLogs(){ localStorage.setItem('logs', JSON.stringify(state.logs)); }
  function addPitch(def){ state.pitch_team[def]=(state.pitch_team[def]||0)+1; }
  function clearCounts(){ state.strike=0; state.ball=0; }
  function currentOffense(){ return state.top?state.teamL:state.teamR; }
  function currentDefense(){ return state.top?state.teamR:state.teamL; }

  /* ====== Undo ====== */
  const historyStack=[];
  function snapshotState(){ return JSON.parse(JSON.stringify(state)); }
  function pushHistory(){ historyStack.push(snapshotState()); }
  function undoLast(){
    const prev=historyStack.pop(); if(!prev) return;
    Object.assign(state, prev); saveBasics(); saveLogs(); updateAll();
  }

  /* 跑者前進 n 壘（不含打者） */
  function advanceRunners(n){
    let scoreAdd=0; const newBases=[false,false,false];
    for(let i=2;i>=0;i--){
      if(state.bases[i]){
        const t=i+n; if(t>=3) scoreAdd+=1; else newBases[t]=true;
      }
    }
    state.bases=newBases;
    if(scoreAdd){ state.score[currentOffense()]+=scoreAdd; }
    return scoreAdd;
  }

  function maybeWalkoff(scoreAdded){
    if(scoreAdded && !state.top && state.inning>=9){
      if(state.score[currentOffense()]>state.score[currentDefense()]){
        endGame(); return true;
      }
    }
    return false;
  }
  function endGame(){ state.game_over=true; saveBasics(); updateAll(); }

  function changeSide(){
    if(state.game_over) return;
    state.out=0; state.strike=0; state.ball=0; state.bases=[false,false,false];
    if(state.top){
      state.top=false;
      if(state.inning>=9){
        if(state.score[currentOffense()]>state.score[currentDefense()]){ endGame(); return; }
      }
    }else{
      const finished=state.inning; state.top=true;
      if(finished>=9 && state.score[state.teamL]!==state.score[state.teamR]){ endGame(); return; }
      state.inning+=1;
    }
    saveBasics(); updateAll();
  }

  /* ====== 事件 ====== */
  function hit(n){
    if(state.edit_mode||state.game_over) return;
    pushHistory(); addPitch(currentDefense());
    let newBases=[false,false,false], scoreAdd=0;
    for(let i=2;i>=0;i--){
      if(state.bases[i]){
        const t=i+n; if(t>=3) scoreAdd+=1; else newBases[t]=true;
      }
    }
    if(n<4){ const dest=n-1; if(dest>=0&&dest<3) newBases[dest]=true; }
    else { scoreAdd+=1; }
    state.bases=newBases; state.score[currentOffense()]+=scoreAdd; clearCounts();
    logEvent(n===1?'一壘安打':n===2?'二壘安打':n===3?'三壘安打':'全壘打');
    if(maybeWalkoff(scoreAdd)) { saveBasics(); updateAll(); return; }
    saveBasics(); updateAll();
  }
  function groundRuleDouble(){ hit(2); }

  function addStrike(){
    if(state.edit_mode||state.game_over) return;
    pushHistory(); addPitch(currentDefense());
    state.strike+=1; logEvent('好球');
    if(state.strike>=3){
      state.strike=0; state.ball=0; state.out+=1;
      if(state.out>=3){ saveBasics(); changeSide(); return; }
    }
    saveBasics(); updateAll();
  }

  function addBall(){
    if(state.edit_mode||state.game_over) return;
    pushHistory(); addPitch(currentDefense());
    state.ball+=1; logEvent('壞球');
    if(state.ball>=4){
      const scored = advanceRunners(1); // 四壞：打者上一壘 + 既有跑者強迫推進
      clearCounts(); logEvent('保送');
      if(maybeWalkoff(scored)) { saveBasics(); updateAll(); return; }
    }
    saveBasics(); updateAll();
  }

  function addOut(lbl){
    if(state.edit_mode||state.game_over) return;
    pushHistory(); addPitch(currentDefense());
    if(lbl) logEvent(lbl);
    state.strike=0; state.ball=0; state.out+=1;
    if(state.out>=3){ saveBasics(); changeSide(); return; }
    saveBasics(); updateAll();
  }

  function hbp(){
    if(state.edit_mode||state.game_over) return;
    pushHistory(); addPitch(currentDefense());
    const scored = advanceRunners(1); // 觸身球：視為打者上一壘、跑者強迫推進
    clearCounts(); logEvent('觸身球');
    if(maybeWalkoff(scored)) { saveBasics(); updateAll(); return; }
    saveBasics(); updateAll();
  }

  function foul(){
    if(state.edit_mode||state.game_over) return;
    pushHistory(); addPitch(currentDefense());
    state.strike += 1; logEvent('界外球'); // 與好球相同，但紀錄為「界外球」
    if(state.strike>=3){
      state.strike=0; state.ball=0; state.out+=1;
      if(state.out>=3){ saveBasics(); changeSide(); return; }
    }
    saveBasics(); updateAll();
  }

  function wp(){
    if(state.edit_mode||state.game_over) return;
    pushHistory(); addPitch(currentDefense());
    state.ball += 1;
    const scored = advanceRunners(1);
    logEvent('暴投');
    if(state.ball>=4){
      const s2 = advanceRunners(1); // 若剛好四壞再強迫推進一次
      clearCounts(); logEvent('保送');
      if(maybeWalkoff(scored+s2)) { saveBasics(); updateAll(); return; }
    }
    if(maybeWalkoff(scored)) { saveBasics(); updateAll(); return; }
    saveBasics(); updateAll();
  }

  function errorHit(){
    if(state.edit_mode||state.game_over) return;
    pushHistory(); addPitch(currentDefense());
    hit(1); // 行為同一壘安打
    state.logs.timeline[state.logs.timeline.length-1].label='失誤'; // 改紀錄文字
    saveBasics(); updateAll();
  }

  function bunt(){
    if(state.edit_mode||state.game_over) return;
    pushHistory(); addPitch(currentDefense());
    const willOut = state.out + 1;
    if(willOut >= 3){
      state.out = willOut; clearCounts(); logEvent('短打成功');
      saveBasics(); changeSide(); return;
    }
    state.out = willOut;
    const scored = advanceRunners(1);
    clearCounts(); logEvent('短打成功');
    if(state.out >= 3){ saveBasics(); changeSide(); return; }
    if(maybeWalkoff(scored)) { saveBasics(); updateAll(); return; }
    saveBasics(); updateAll();
  }

  /* ====== Log 與 UI ====== */
  function logEvent(lbl){
    state.logs.timeline.push({
      inning:state.inning,
      half:state.top?'上':'下',
      pitcherTeam:currentDefense(),
      label:lbl,
      scoreL:state.score[state.teamL]||0,
      scoreR:state.score[state.teamR]||0
    });
    saveLogs(); renderLog();
  }

  function renderLog(){
    const byInning={};
    for(const e of state.logs.timeline){
      const key=e.inning; byInning[key] ||= {L:[],R:[]};
      (e.pitcherTeam===state.teamL?byInning[key].L:byInning[key].R).push(e);
    }
    const keys=Object.keys(byInning).map(Number).sort((a,b)=>a-b);
    let html='';
    for(const k of keys){
      const Lseq=byInning[k].L, Rseq=byInning[k].R;
      const maxLen=Math.max(Lseq.length,Rseq.length);
      for(let i=0;i<maxLen;i++){
        const Lev=Lseq[i], Rev=Rseq[i];
        const scoreStr=Rev?`${Rev.scoreL}:${Rev.scoreR}`:(Lev?`${Lev.scoreL}:${Lev.scoreR}`:'');
        html+=`<tr><td class="inning">${k}</td><td>${Lev?Lev.label:'X'}</td><td>${Rev?Rev.label:'X'}</td><td class="score">${scoreStr}</td></tr>`;
      }
    }
    el.logBody.innerHTML = html || `<tr><td colspan="4" style="opacity:.7">尚無紀錄</td></tr>`;
    el.thTeamL.textContent=state.teamL+'（投手）';
    el.thTeamR.textContent=state.teamR+'（投手）';
  }

  function setLights(row,count,max,color){
    const dots=row.querySelectorAll('.light:not(.clear)');
    dots.forEach((dot,idx)=>{
      dot.style.background=(idx<count)?color:OFF;
      dot.onclick=()=>{ if(!state.edit_mode) return;
        if(row===el.rowS) state.strike=Math.min(idx+1,2);
        if(row===el.rowB) state.ball=Math.min(idx+1,3);
        if(row===el.rowO) state.out=Math.min(idx+1,2);
        updateAll();
      };
      dot.oncontextmenu=(e)=>{ if(!state.edit_mode) return; e.preventDefault();
        if(row===el.rowS) state.strike=0;
        if(row===el.rowB) state.ball=0;
        if(row===el.rowO) state.out=0;
        updateAll(); return false;
      };
    });
    const clearBtn=row.querySelector('.clear');
    clearBtn.style.display=state.edit_mode?'inline-block':'none';
    clearBtn.onclick=()=>{ if(!state.edit_mode) return;
      if(row===el.rowS) state.strike=0;
      if(row===el.rowB) state.ball=0;
      if(row===el.rowO) state.out=0;
      updateAll();
    };
  }

  function updateAll(){
    el.banner.textContent=`${state.inning} 局 ${state.top?'上':'下'}`;
    el.info.textContent=`攻方：${currentOffense()}　守方：${currentDefense()}`;

    if(!state.game_over){
      el.gameover.textContent="";
      el.pitch.textContent=`PITCH ${currentDefense()}: ${state.pitch_team[currentDefense()]||0}`;
    }else{
      el.gameover.textContent="比賽結束！";
    }

    document.getElementById('b1').style.background = state.bases[0] ? S_ON : OFF;
    document.getElementById('b2').style.background = state.bases[1] ? S_ON : OFF;
    document.getElementById('b3').style.background = state.bases[2] ? S_ON : OFF;

    el.teamA.textContent=state.teamL;
    el.teamB.textContent=state.teamR;
    el.scoreA.textContent=state.score[state.teamL]||0;
    el.scoreB.textContent=state.score[state.teamR]||0;

    setLights(el.rowS,Math.min(state.strike,2),2,S_ON);
    setLights(el.rowB,Math.min(state.ball,3),3,B_ON);
    setLights(el.rowO,Math.min(state.out,2),2,O_ON);

    el.pMinus.classList.toggle('hidden',!state.edit_mode);
    el.pPlus.classList.toggle('hidden',!state.edit_mode);
    el.scoreAdjust.classList.toggle('hidden',!state.edit_mode);

    document.querySelectorAll('.actions-rows .btn').forEach(btn=>{
      if(btn.id!=='btnSetupStart'){ btn.disabled = state.edit_mode || state.game_over; }
    });

    renderLog();
    saveBasics();
  }

  /* ====== 監聽 ====== */
  document.querySelectorAll('.act').forEach(b=>{
    const act=b.dataset.act;
    b.addEventListener('click',()=>{
      if(act==='strike') addStrike();
      else if(act==='ball') addBall();
      else if(act==='ground') addOut('滾地球');
      else if(act==='fly') addOut('高飛球');
      else if(act==='foul') foul();
      else if(act==='grd') groundRuleDouble();
      else if(act==='hbp') hbp();
      else if(act==='wp') wp();
      else if(act==='err') errorHit();
      else if(act==='bunt') bunt();
      else if(act.startsWith('hit-')){ hit(parseInt(act.split('-')[1],10)); }
    });
  });

  el.btnEdit.addEventListener('click',()=>{
    state.edit_mode=!state.edit_mode;
    el.btnEdit.textContent=state.edit_mode?'完成':'編輯';
    updateAll();
  });

  // 編輯：分數 / PITCH 微調
  el.pPlus.addEventListener('click',()=>{ if(!state.edit_mode) return;
    pushHistory(); const def=currentDefense();
    state.pitch_team[def]=(state.pitch_team[def]||0)+1; updateAll(); });
  el.pMinus.addEventListener('click',()=>{ if(!state.edit_mode) return;
    pushHistory(); const def=currentDefense();
    state.pitch_team[def]=Math.max(0,(state.pitch_team[def]||0)-1); updateAll(); });
  el.sPlus.addEventListener('click',()=>{ if(!state.edit_mode) return;
    pushHistory(); const off=currentOffense();
    state.score[off]=(state.score[off]||0)+1; updateAll(); });
  el.sMinus.addEventListener('click',()=>{ if(!state.edit_mode) return;
    pushHistory(); const off=currentOffense();
    state.score[off]=Math.max(0,(state.score[off]||0)-1); updateAll(); });

  // 編輯：點壘包切換佔壘
  [el.b1,el.b2,el.b3].forEach((node,idx)=>{
    node.style.cursor='pointer';
    node.title='編輯模式：點擊切換佔壘';
    node.addEventListener('click',()=>{ if(!state.edit_mode) return;
      pushHistory(); state.bases[idx]=!state.bases[idx]; updateAll(); });
  });

  // 復原上一步
  el.btnUndo.addEventListener('click',()=>{ undoLast(); });

  // 設定頁
  el.btnReset.addEventListener('click', openSetup);
  el.btnSetupStart.addEventListener('click', ()=>{
    const off=(el.inTeamOff.value||'先攻隊伍').trim();
    const def=(el.inTeamDef.value||'先守隊伍').trim();
    state.teamL=off; state.teamR=def;
    state.inning=1; state.top=true; state.strike=0; state.ball=0; state.out=0;
    state.pitch_team[off]=0; state.pitch_team[def]=0;
    state.score[off]=0; state.score[def]=0;
    state.bases=[false,false,false]; state.game_over=false; state.logs={timeline:[]};
    closeSetup(); updateAll();
  });
  function openSetup(){ el.inTeamOff.value=state.teamL; el.inTeamDef.value=state.teamR; el.setup.classList.remove('hidden'); }
  function closeSetup(){ el.setup.classList.add('hidden'); }

  // 初始渲染
  updateAll();

  // PWA
  if('serviceWorker' in navigator){ window.addEventListener('load',()=>navigator.serviceWorker.register('service-worker.js')); }
})();
</script>
</body>
</html>
