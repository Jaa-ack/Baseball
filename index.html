<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover,maximum-scale=1">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <link rel="manifest" href="manifest.json">
  <link rel="apple-touch-icon" href="icons/icon-192.png">
  <title>棒球比賽紀錄器 PWA</title>
  <style>
    :root{
      --bg:#1B3B2A;
      --panel:#2C2C29;
      --text:#F9F9F4;
      --btn:#D0D3D4;
      --btnfg:#111;
      --btnactive:#B5BABB;
      --off:#4A4A42;
      --s-on:#FFEB3B;
      --b-on:#6BE870;
      --o-on:#FF6E6E;
      --tbl:#3a3a36;

      /* 壘包尺寸（桌機預設），行動裝置會覆寫 */
      --bases-w: 260px;
      --bases-h: 220px;
      --base-size: 20px;
      --home-w: 26px;
      --home-h: 20px;

      /* 主要字級（行動裝置會略縮放） */
      --h1:20px;
      --pitch-fz:18px;
      --pa-fz:14px;
      --points-fz:22px;

      /* 互動按鈕尺寸 */
      --circle-btn:64px;
      --square-minw:120px;
      --panel-pad:12px;
      --gap:10px;
    }

    /* ====== 共用 ====== */
    html,body{margin:0;padding:0;background:var(--bg);color:var(--text);
      font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans",sans-serif;}
    .wrap{max-width:980px;margin:0 auto;padding:12px;}
    .panel{background:var(--panel);border-radius:14px;padding:var(--panel-pad);
      box-shadow:0 6px 20px rgba(0,0,0,.25);}
    .row{display:flex;align-items:center;gap:var(--gap);flex-wrap:wrap;}
    .topbar{justify-content:space-between}
    h1{font-size:var(--h1);margin:0}
    .btn{background:var(--btn);color:var(--btnfg);border:none;border-radius:10px;
      padding:10px 12px;font-weight:600;cursor:pointer;touch-action:manipulation}
    .btn:active{background:var(--btnactive)}
    .btn.toggle{min-width:88px;border-radius:999px}
    .btn.toggle.active{background:var(--b-on);color:#111}
    .grid{display:grid;gap:10px}
    .scorebox{border:1px solid #6A6F68;border-radius:10px;padding:10px 12px}
    .lights-row{display:flex;align-items:center;gap:8px;margin:8px 0}
    .light{width:26px;height:26px;border-radius:50%;background:var(--off);}
    .light.clear{outline:2px dashed #666;outline-offset:3px;display:none;}
    .label{font-weight:700;width:22px;text-align:center}

    /* 壘包菱形（使用變數，行動裝置會放大） */
    .bases{position:relative;width:var(--bases-w);height:var(--bases-h);background:var(--panel);margin-inline:auto}
    .base{position:absolute;width:var(--base-size);height:var(--base-size);background:var(--off)}
    /* 位置參考依據尺寸比例微調 */
    .b1{left:calc(var(--bases-w) - 60px); top:calc(var(--bases-h)/2 - 6px)}
    .b2{left:calc(var(--bases-w)/2 - 8px); top:30px}
    .b3{left:45px; top:calc(var(--bases-h)/2 - 6px)}
    .home{position:absolute;left:calc(var(--bases-w)/2 - var(--home-w)/2); top:calc(var(--bases-h) - 40px);
      width:var(--home-w);height:var(--home-h);background:white; clip-path:polygon(50% 100%, 0 0, 100% 0)}

    .pitch{font-size:var(--pitch-fz);font-weight:800}
    .pitch-line{display:flex;align-items:center;gap:8px}
    .pa-line{font-size:var(--pa-fz);margin-top:6px;display:flex;align-items:center;gap:8px}
    .endbanner{color:var(--o-on);font-weight:900;font-size:18px;text-align:center;min-height:26px}
    .hidden{display:none!important;}
    .scoretbl{width:100%;border-collapse:collapse}
    .scoretbl th,.scoretbl td{padding:8px 6px}
    .scoretbl .points{font-size:var(--points-fz);font-weight:900;color:var(--b-on)}

    /* 動作列：行動裝置兩欄，桌機保持自適應 */
    .actions-rows{display:grid;gap:12px}
    .actions-rows .line{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:10px}
    .btn.circle{width:var(--circle-btn);height:var(--circle-btn);border-radius:50%;font-size:16px;font-weight:800;justify-self:start}
    .btn.square{border-radius:12px;min-width:var(--square-minw);justify-self:stretch}

    /* 逐球表：行動裝置高度自適 40vh，讓使用中仍看得到 */
    .logbox{max-height:40vh;overflow:auto;border:1px solid var(--tbl);border-radius:12px}
    .logtbl{width:100%;border-collapse:collapse;border:1px solid var(--tbl)}
    .logtbl th,.logtbl td{border-bottom:1px solid var(--tbl);padding:8px 10px;text-align:center}

    .setup{position:fixed;inset:0;background:rgba(0,0,0,.6);display:flex;
      align-items:center;justify-content:center;z-index:50;}
    .setup .card{width:min(680px,92vw);background:var(--panel);border-radius:16px;
      padding:18px;box-shadow:0 10px 30px rgba(0,0,0,.5)}

    /* ====== 行動裝置（iPhone）優化 ====== */
    @media (max-width: 480px){
      :root{
        --h1:18px;
        --pitch-fz:16px;
        --pa-fz:13px;
        --points-fz:20px;
        --circle-btn:56px;
        --square-minw:auto;
        --panel-pad:10px;
        --gap:8px;

        /* 壘包更大一些 */
        --bases-w: 300px;
        --bases-h: 250px;
        --base-size: 22px;
        --home-w: 28px;
        --home-h: 22px;
      }
      .wrap{padding:8px}
      .row.topbar{gap:6px}
      .scorebox{margin-top:6px}
      /* 互動區塊順序：資訊 → PITCH/PA → S/B/O/站位 → 壘包 → 比分 → 動作按鈕 → 逐球表 */
      .layout-mobile{display:grid;gap:12px}
      .lights-row .light{width:24px;height:24px}
      /* 讓重要資訊貼齊上方 */
      .panel{padding:var(--panel-pad)}
    }

    /* ====== 桌機（較寬）維持雙欄 ====== */
    @media (min-width: 768px){
      .main-grid{
        display:grid;
        grid-template-columns: 1fr 280px;
        gap:16px;
        align-items:start;
      }
      .actions-rows .line{grid-template-columns:repeat(4,minmax(0,1fr))}
      .btn.circle{justify-self:stretch}
      .btn.square{justify-self:stretch}
    }
  </style>
</head>
<body>
<div class="wrap">
  <div class="panel layout-mobile">
    <!-- Top bar -->
    <div class="row topbar">
      <div>
        <h1 id="banner"></h1>
        <div id="info" class="info"></div>
      </div>
      <div class="row" style="gap:8px">
        <button id="btnReset" class="btn muted">重新設定</button>
        <button id="btnEdit" class="btn">編輯</button>
      </div>
    </div>

    <!-- 主體：左側資訊 + 右側比分（桌機為雙欄，行動裝置直排） -->
    <div class="main-grid">
      <!-- 左側：PITCH/PA + S/B/O + 站位 + 壘包 -->
      <div>
        <!-- PITCH/PA 區 -->
        <div class="pitchbox">
          <div id="pitchLine" class="pitch-line">
            <div id="pitch" class="pitch mono"></div>
            <button id="pMinus" class="btn hidden">-</button>
            <button id="pPlus" class="btn hidden">+</button>
          </div>
          <div id="paLine" class="pa-line">
            <span id="paLabel">累計打席 先攻隊伍：0</span>
            <button id="paMinus" class="btn hidden">-</button>
            <button id="paPlus"  class="btn hidden">+</button>
          </div>
        </div>

        <!-- 站位 / S B O 燈 -->
        <div style="margin-top:6px">
          <div class="lights-row" id="rowStance" style="justify-content:flex-start">
            <button id="btnLeftBat"  class="btn toggle">左打</button>
            <button id="btnRightBat" class="btn toggle">右打</button>
          </div>
          <div class="lights-row" id="rowS">
            <div class="light clear" id="clearS" title="清空好球"></div>
            <div class="label">S</div>
            <div class="light" data-s="1"></div>
            <div class="light" data-s="2"></div>
          </div>
          <div class="lights-row" id="rowB">
            <div class="light clear" id="clearB" title="清空壞球"></div>
            <div class="label">B</div>
            <div class="light" data-b="1"></div>
            <div class="light" data-b="2"></div>
            <div class="light" data-b="3"></div>
          </div>
          <div class="lights-row" id="rowO">
            <div class="light clear" id="clearO" title="清空出局燈"></div>
            <div class="label">O</div>
            <div class="light" data-o="1"></div>
            <div class="light" data-o="2"></div>
          </div>
        </div>

        <!-- 壘包（行動裝置會放大） -->
        <div class="bases panel">
          <div class="base b1" id="b1"></div>
          <div class="base b2" id="b2"></div>
          <div class="base b3" id="b3"></div>
          <div class="home"></div>
        </div>
      </div>

      <!-- 右側：比分 + 比賽結束訊息 -->
      <div>
        <div style="min-width:0" class="scorebox">
          <div id="gameover" class="endbanner"></div>
          <table class="scoretbl">
            <thead><tr><th>隊伍</th><th>分數</th></tr></thead>
            <tbody>
              <tr><td id="teamA"></td><td id="scoreA" class="points">0</td></tr>
              <tr><td id="teamB"></td><td id="scoreB" class="points">0</td></tr>
            </tbody>
          </table>
          <div id="scoreAdjust" class="row hidden" style="margin-top:6px">
            <button id="sMinus" class="btn">-</button>
            <button id="sPlus"  class="btn">+</button>
          </div>
        </div>
      </div>
    </div>

    <!-- 動作按鈕（在手機上兩欄網格，避免太寬） -->
    <div class="panel" style="margin-top:8px">
      <div class="actions-rows">
        <div class="line">
          <button class="btn circle act" data-act="strike">好球</button>
          <button class="btn circle act" data-act="ball">壞球</button>
        </div>
        <div class="line">
          <button class="btn square act" data-act="ground">滾地球</button>
          <button class="btn square act" data-act="fly">高飛球</button>
          <button class="btn square act" data-act="foul">界外球</button>
          <button class="btn square act" data-act="hbp">觸身球</button>
        </div>
        <div class="line">
          <button class="btn square act" data-act="hit-1">一壘安打</button>
          <button class="btn square act" data-act="hit-2">二壘安打</button>
          <button class="btn square act" data-act="hit-3">三壘安打</button>
          <button class="btn square act" data-act="hit-4">全壘打</button>
        </div>
        <div class="line">
          <button class="btn square act" data-act="grd">場地規則</button>
          <button class="btn square act" data-act="wp">暴投</button>
          <button class="btn square act" data-act="err">失誤</button>
          <button class="btn square act" data-act="bunt">短打成功</button>
        </div>
      </div>
    </div>

    <!-- 逐球紀錄（手機視窗 40vh，操作同時可見） -->
    <div class="logwrap">
      <div class="loghead row" style="justify-content:space-between;align-items:center">
        <h3 style="margin:0">逐球紀錄</h3>
        <div class="row">
          <button id="btnUndo" class="btn">↩︎ 復原上一步</button>
          <button id="btnExport" class="btn">匯出 CSV</button>
        </div>
      </div>
      <div class="logbox">
        <table class="logtbl" id="logTable">
          <thead>
            <tr>
              <th class="inning">局數</th>
              <th id="thDefPitch">先守隊伍（投手）</th>
              <th id="thOffBat">先攻隊伍（打擊）</th>
              <th id="thOffPitch">先攻隊伍（投手）</th>
              <th id="thDefBat">先守隊伍（打擊）</th>
              <th class="score">比分</th>
            </tr>
          </thead>
          <tbody id="logBody"></tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<!-- 賽前設定 -->
<div id="setup" class="setup hidden">
  <div class="card">
    <h2>賽前設定</h2>
    <p class="subtle">請輸入兩隊名稱</p>
    <div class="teams-flex">
      <div class="teamcard">
        <h4>先攻隊伍名稱</h4>
        <div class="fld"><input id="inTeamOff" placeholder="先攻隊伍"></div>
      </div>
      <div class="teamcard">
        <h4>先守隊伍名稱</h4>
        <div class="fld"><input id="inTeamDef" placeholder="先守隊伍"></div>
      </div>
    </div>
    <div class="actbar"><button id="btnSetupStart" class="btn">開始比賽</button></div>
  </div>
</div>

<script>
(function(){
  const S_ON=getComputedStyle(document.documentElement).getPropertyValue('--s-on').trim();
  const B_ON=getComputedStyle(document.documentElement).getPropertyValue('--b-on').trim();
  const O_ON=getComputedStyle(document.documentElement).getPropertyValue('--o-on').trim();
  const OFF =getComputedStyle(document.documentElement).getPropertyValue('--off').trim();

  const state={
    teamL: localStorage.getItem('teamL')||'先攻隊伍',
    teamR: localStorage.getItem('teamR')||'先守隊伍',
    inning: parseInt(localStorage.getItem('inning')||'1',10),
    top: (localStorage.getItem('top')||'1')==='1',
    strike:0,ball:0,out:0,
    pitch_team:{},
    score:{},
    bases:[false,false,false],
    edit_mode:false,game_over:false,
    logs: JSON.parse(localStorage.getItem('logs')||'{"timeline":[]}'),
    stance: localStorage.getItem('stance') || '右打',
    innings: JSON.parse(localStorage.getItem('innings')||'[]') // 方案A：每局 top/bottom PA 陣列
  };

  const el={
    banner:document.getElementById('banner'),
    info:document.getElementById('info'),
    btnEdit:document.getElementById('btnEdit'),
    btnReset:document.getElementById('btnReset'),
    rowS:document.getElementById('rowS'),
    rowB:document.getElementById('rowB'),
    rowO:document.getElementById('rowO'),
    b1:document.getElementById('b1'),
    b2:document.getElementById('b2'),
    b3:document.getElementById('b3'),
    pitch:document.getElementById('pitch'),
    pMinus:document.getElementById('pMinus'),
    pPlus:document.getElementById('pPlus'),
    paLabel:document.getElementById('paLabel'),
    paMinus:document.getElementById('paMinus'),
    paPlus:document.getElementById('paPlus'),
    teamA:document.getElementById('teamA'),
    teamB:document.getElementById('teamB'),
    scoreA:document.getElementById('scoreA'),
    scoreB:document.getElementById('scoreB'),
    gameover:document.getElementById('gameover'),
    scoreAdjust:document.getElementById('scoreAdjust'),
    sMinus:document.getElementById('sMinus'),
    sPlus:document.getElementById('sPlus'),
    setup:document.getElementById('setup'),
    inTeamOff:document.getElementById('inTeamOff'),
    inTeamDef:document.getElementById('inTeamDef'),
    btnSetupStart:document.getElementById('btnSetupStart'),
    thDefPitch:document.getElementById('thDefPitch'),
    thOffBat:document.getElementById('thOffBat'),
    thOffPitch:document.getElementById('thOffPitch'),
    thDefBat:document.getElementById('thDefBat'),
    logBody:document.getElementById('logBody'),
    btnUndo:document.getElementById('btnUndo'),
    btnExport:document.getElementById('btnExport'),
    btnLeftBat:document.getElementById('btnLeftBat'),
    btnRightBat:document.getElementById('btnRightBat'),
  };

  // 初始化分數與投球數
  const L=state.teamL, R=state.teamR;
  state.pitch_team[L]=parseInt(localStorage.getItem('pitch_'+L)||'0',10);
  state.pitch_team[R]=parseInt(localStorage.getItem('pitch_'+R)||'0',10);
  state.score[L]=parseInt(localStorage.getItem('score_'+L)||'0',10);
  state.score[R]=parseInt(localStorage.getItem('score_'+R)||'0',10);

  // 初始化 innings 結構
  function ensureInningStruct(n){
    while(state.innings.length < n){
      state.innings.push({inning: state.innings.length+1, top:[], bottom:[]});
    }
  }
  ensureInningStruct(state.inning);

  if(!localStorage.getItem('teamL')||!localStorage.getItem('teamR')) openSetup();

  el.teamA.textContent=state.teamL;
  el.teamB.textContent=state.teamR;

  /* ====== 儲存/工具 ====== */
  function saveBasics(){
    localStorage.setItem('teamL',state.teamL);
    localStorage.setItem('teamR',state.teamR);
    localStorage.setItem('pitch_'+state.teamL,state.pitch_team[state.teamL]||0);
    localStorage.setItem('pitch_'+state.teamR,state.pitch_team[state.teamR]||0);
    localStorage.setItem('score_'+state.teamL,state.score[state.teamL]||0);
    localStorage.setItem('score_'+state.teamR,state.score[state.teamR]||0);
    localStorage.setItem('inning',state.inning);
    localStorage.setItem('top',state.top?'1':'0');
    localStorage.setItem('stance',state.stance);
  }
  function saveLogs(){ localStorage.setItem('logs', JSON.stringify(state.logs)); }
  function saveInnings(){ localStorage.setItem('innings', JSON.stringify(state.innings)); }
  function addPitch(def){ state.pitch_team[def]=(state.pitch_team[def]||0)+1; }
  function clearCounts(){ state.strike=0; state.ball=0; }
  function currentOffense(){ return state.top?state.teamL:state.teamR; }
  function currentDefense(){ return state.top?state.teamR:state.teamL; }
  function currentHalfArray(){
    ensureInningStruct(state.inning);
    const idx=state.inning-1;
    return state.top ? state.innings[idx].top : state.innings[idx].bottom;
  }
  function totalPAs(team){
    let sum=0;
    state.innings.forEach(inn=>{
      if(team===state.teamL) sum += inn.top.length;
      else if(team===state.teamR) sum += inn.bottom.length;
    });
    return sum;
  }

  /* ====== Undo ====== */
  const historyStack=[];
  function snapshotState(){ return JSON.parse(JSON.stringify(state)); }
  function pushHistory(){ historyStack.push(snapshotState()); }
  function undoLast(){
    const prev=historyStack.pop(); if(!prev) return;
    Object.assign(state, prev); saveBasics(); saveLogs(); saveInnings(); updateAll();
  }

  /* 跑者前進 n 壘（不含打者） */
  function advanceRunners(n){
    let scoreAdd=0; const newBases=[false,false,false];
    for(let i=2;i>=0;i--){
      if(state.bases[i]){
        const t=i+n; if(t>=3) scoreAdd+=1; else newBases[t]=true;
      }
    }
    state.bases=newBases;
    if(scoreAdd){ state.score[currentOffense()]+=scoreAdd; }
    return scoreAdd;
  }

  function maybeWalkoff(scoreAdded){
    if(scoreAdded && !state.top && state.inning>=9){
      if(state.score[currentOffense()]>state.score[currentDefense()]){
        endGame(); return true;
      }
    }
    return false;
  }

  function endGame(){
    state.game_over=true;
    const pitchL = state.pitch_team[state.teamL]||0;
    const pitchR = state.pitch_team[state.teamR]||0;
    const paL = totalPAs(state.teamL);
    const paR = totalPAs(state.teamR);
    saveBasics(); saveInnings();
    updateAll();
    el.gameover.textContent =
      `比賽結束！  ${state.teamL}：PITCH ${pitchL}／PA ${paL}　|　${state.teamR}：PITCH ${pitchR}／PA ${paR}`;
  }

  function changeSide(){
    if(state.game_over) return;
    state.out=0; state.strike=0; state.ball=0; state.bases=[false,false,false];
    if(state.top){
      state.top=false;
    }else{
      const finished=state.inning; state.top=true;
      if(finished>=9 && state.score[state.teamL]!==state.score[state.teamR]){ endGame(); return; }
      state.inning+=1;
      ensureInningStruct(state.inning);
    }
    saveBasics(); updateAll();
  }

  /* ====== 打席結束 → 紀錄到 innings ====== */
  function pushPAFromLastEvent(reasonTag){
    for(let i=state.logs.timeline.length-1;i>=0;i--){
      const e=state.logs.timeline[i];
      if(e && !e.sep){
        const paObj={
          summary: e.label||reasonTag||'結果',
          stance:  e.stance||'',
          scoreL:  e.scoreL||0,
          scoreR:  e.scoreR||0,
          manual:  false,
          reason:  reasonTag||''
        };
        currentHalfArray().push(paObj);
        saveInnings();
        return;
      }
    }
    currentHalfArray().push({
      summary: reasonTag||'結果', stance:'', scoreL:state.score[state.teamL]||0, scoreR:state.score[state.teamR]||0, manual:false
    });
    saveInnings();
  }

  /* ====== 事件 ====== */
  function hit(n){
    if(state.edit_mode||state.game_over) return;
    pushHistory(); addPitch(currentDefense());
    let newBases=[false,false,false], scoreAdd=0;
    for(let i=2;i>=0;i--){
      if(state.bases[i]){
        const t=i+n; if(t>=3) scoreAdd+=1; else newBases[t]=true;
      }
    }
    if(n<4){ const dest=n-1; if(dest>=0&&dest<3) newBases[dest]=true; }
    else { scoreAdd+=1; }
    state.bases=newBases; state.score[currentOffense()]+=scoreAdd; clearCounts();
    logEvent(n===1?'一壘安打':n===2?'二壘安打':n===3?'三壘安打':'全壘打');
    pushPAFromLastEvent('hit');
    if(maybeWalkoff(scoreAdd)) { saveBasics(); updateAll(); return; }
    saveBasics(); updateAll();
  }
  function groundRuleDouble(){ hit(2); }

  function addStrike(){
    if(state.edit_mode||state.game_over) return;
    pushHistory(); addPitch(currentDefense());
    state.strike+=1;
    if(state.strike>=3){
      state.strike=0; state.ball=0; state.out+=1;
      logEvent('三振');
      pushPAFromLastEvent('strikeout');
      if(state.out>=3){ saveBasics(); changeSide(); return; }
    }else{
      logEvent('好球');
    }
    saveBasics(); updateAll();
  }

  function addBall(){
    if(state.edit_mode||state.game_over) return;
    pushHistory(); addPitch(currentDefense());
    state.ball+=1; logEvent('壞球');
    if(state.ball>=4){
      let [b1,b2,b3] = state.bases;
      let scoreAdd = 0;
      if (b1){
        if (b2){
          if (b3){ scoreAdd += 1; }
          b3 = true;
        }
        b2 = true;
      }
      b1 = true;
      state.bases = [b1,b2,b3];
      if (scoreAdd) state.score[currentOffense()] += scoreAdd;
      clearCounts(); logEvent('保送');
      pushPAFromLastEvent('walk');
      if(maybeWalkoff(scoreAdd)) { saveBasics(); updateAll(); return; }
    }
    saveBasics(); updateAll();
  }

  function addOut(lbl){
    if(state.edit_mode||state.game_over) return;
    pushHistory(); addPitch(currentDefense());
    if(lbl) logEvent(lbl);
    state.strike=0; state.ball=0; state.out+=1;
    pushPAFromLastEvent('out');
    if(state.out>=3){ saveBasics(); changeSide(); return; }
    saveBasics(); updateAll();
  }

  function hbp(){
    if(state.edit_mode||state.game_over) return;
    pushHistory(); addPitch(currentDefense());
    let [b1,b2,b3] = state.bases;
    let scoreAdd = 0;
    if (b1){
      if (b2){
        if (b3){ scoreAdd += 1; }
        b3 = true;
      }
      b2 = true;
    }
    b1 = true;
    state.bases = [b1,b2,b3];
    if (scoreAdd) state.score[currentOffense()] += scoreAdd;
    clearCounts(); logEvent('觸身球');
    pushPAFromLastEvent('hbp');
    if(maybeWalkoff(scoreAdd)) { saveBasics(); updateAll(); return; }
    saveBasics(); updateAll();
  }

  function foul(){
    if(state.edit_mode||state.game_over) return;
    pushHistory(); addPitch(currentDefense());
    state.strike += 1;
    if(state.strike>=3){
      state.strike=0; state.ball=0; state.out+=1;
      logEvent('界外三振');
      pushPAFromLastEvent('foulK');
      if(state.out>=3){ saveBasics(); changeSide(); return; }
    }else{
      logEvent('界外球');
    }
    saveBasics(); updateAll();
  }

  function wp(){
    if(state.edit_mode||state.game_over) return;
    pushHistory(); addPitch(currentDefense());
    const scoredFromWP = advanceRunners(1);
    logEvent('暴投');
    state.ball += 1;
    let extraScore = 0;
    if(state.ball>=4){
      let [b1,b2,b3] = state.bases;
      if (b1){
        if (b2){
          if (b3){ extraScore += 1; }
          b3 = true;
        }
        b2 = true;
      }
      b1 = true;
      state.bases = [b1,b2,b3];
      if (extraScore) state.score[currentOffense()] += extraScore;
      clearCounts(); logEvent('保送');
      pushPAFromLastEvent('walk-wp');
    }
    if(maybeWalkoff(scoredFromWP + extraScore)) { saveBasics(); updateAll(); return; }
    saveBasics(); updateAll();
  }

  function errorHit(){
    if(state.edit_mode||state.game_over) return;
    pushHistory();
    hit(1);
    const arr = currentHalfArray();
    if(arr.length>0){ arr[arr.length-1].summary='失誤'; saveInnings(); }
    saveBasics(); updateAll();
  }

  function bunt(){
    if(state.edit_mode||state.game_over) return;
    pushHistory(); addPitch(currentDefense());
    const willOut = state.out + 1;
    if(willOut >= 3){
      state.out = willOut; clearCounts(); logEvent('短打成功');
      pushPAFromLastEvent('sac-bunt');
      saveBasics(); changeSide(); return;
    }
    state.out = willOut;
    const scored = advanceRunners(1);
    clearCounts(); logEvent('短打成功');
    pushPAFromLastEvent('sac-bunt');
    if(state.out >= 3){ saveBasics(); changeSide(); return; }
    if(maybeWalkoff(scored)) { saveBasics(); updateAll(); return; }
    saveBasics(); updateAll();
  }

  /* ====== Log / UI ====== */
  function logEvent(lbl){
    const off=currentOffense(), def=currentDefense();
    state.logs.timeline.push({
      inning:state.inning,
      half:state.top?'上':'下',
      offenseTeam: off,
      defenseTeam: def,
      stance: state.stance,
      label:lbl,
      scoreL:state.score[state.teamL]||0,
      scoreR:state.score[state.teamR]||0
    });
    saveLogs(); renderLog();
  }

  function renderLog(){
    el.thDefPitch.textContent = `${state.teamR}（投手）`;
    el.thOffBat.textContent   = `${state.teamL}（打擊）`;
    el.thOffPitch.textContent = `${state.teamL}（投手）`;
    el.thDefBat.textContent   = `${state.teamR}（打擊）`;

    let html='';
    for(const e of state.logs.timeline){
      if(e.sep){ continue; }
      const isTop = (e.half==='上');
      const col1 = isTop ? e.label : '';
      const col2 = isTop ? e.stance: '';
      const col3 = isTop ? ''       : e.label;
      const col4 = isTop ? ''       : e.stance;
      const scoreStr = `${e.scoreL}：${e.scoreR}`;
      html+=`<tr>
        <td class="inning">${e.inning}</td>
        <td>${col1||'—'}</td>
        <td>${col2||'—'}</td>
        <td>${col3||'—'}</td>
        <td>${col4||'—'}</td>
        <td class="score">${scoreStr}</td>
      </tr>`;
    }
    el.logBody.innerHTML = html || `<tr><td colspan="6" style="opacity:.7">尚無紀錄</td></tr>`;
  }

  function setLights(row,count,max,color){
    const dots=row.querySelectorAll('.light:not(.clear)');
    dots.forEach((dot,idx)=>{
      dot.style.background=(idx<count)?color:OFF;
      dot.onclick=()=>{ if(!state.edit_mode) return;
        if(row===el.rowS) state.strike=Math.min(idx+1,2);
        if(row===el.rowB) state.ball=Math.min(idx+1,3);
        if(row===el.rowO) state.out=Math.min(idx+1,2);
        updateAll();
      };
      dot.oncontextmenu=(e)=>{ if(!state.edit_mode) return; e.preventDefault();
        if(row===el.rowS) state.strike=0;
        if(row===el.rowB) state.ball=0;
        if(row===el.rowO) state.out=0;
        updateAll(); return false;
      };
    });
    const clearBtn=row.querySelector('.clear');
    clearBtn.style.display=state.edit_mode?'inline-block':'none';
    clearBtn.onclick=()=>{ if(!state.edit_mode) return;
      if(row===el.rowS) state.strike=0;
      if(row===el.rowB) state.ball=0;
      if(row===el.rowO) state.out=0;
      updateAll();
    };
  }

  function updateAll(){
    el.banner.textContent=`${state.inning} 局 ${state.top?'上':'下'}`;
    el.info.textContent=`攻方：${currentOffense()}　守方：${currentDefense()}`;

    if(!state.game_over){
      el.gameover.textContent="";
      el.pitch.textContent=`PITCH ${currentDefense()}: ${state.pitch_team[currentDefense()]||0}`;
    }

    // 累計打席（整場累計；顯示目前攻擊方隊名）
    const offenseTeam = currentOffense();
    const paCountTotal = totalPAs(offenseTeam);
    el.paLabel.textContent = `累計打席 ${offenseTeam}：${paCountTotal}`;
    el.paMinus.classList.toggle('hidden', !state.edit_mode);
    el.paPlus.classList.toggle('hidden', !state.edit_mode);

    document.getElementById('b1').style.background = state.bases[0] ? S_ON : OFF;
    document.getElementById('b2').style.background = state.bases[1] ? S_ON : OFF;
    document.getElementById('b3').style.background = state.bases[2] ? S_ON : OFF;

    el.teamA.textContent=state.teamL;
    el.teamB.textContent=state.teamR;
    el.scoreA.textContent=state.score[state.teamL]||0;
    el.scoreB.textContent=state.score[state.teamR]||0;

    setLights(el.rowS,Math.min(state.strike,2),2,S_ON);
    setLights(el.rowB,Math.min(state.ball,3),3,B_ON);
    setLights(el.rowO,Math.min(state.out,2),2,O_ON);

    el.btnLeftBat.classList.toggle('active', state.stance==='左打');
    el.btnRightBat.classList.toggle('active', state.stance==='右打');

    el.pMinus.classList.toggle('hidden',!state.edit_mode);
    el.pPlus.classList.toggle('hidden',!state.edit_mode);
    el.scoreAdjust.classList.toggle('hidden',!state.edit_mode);

    document.querySelectorAll('.actions-rows .btn').forEach(btn=>{
      if(btn.id!=='btnSetupStart'){ btn.disabled = state.edit_mode || state.game_over; }
    });

    renderLog();
    saveBasics();
  }

  /* ====== 監聽 ====== */
  document.querySelectorAll('.act').forEach(b=>{
    const act=b.dataset.act;
    b.addEventListener('click',()=>{
      if(act==='strike') addStrike();
      else if(act==='ball') addBall();
      else if(act==='ground') addOut('滾地球');
      else if(act==='fly') addOut('高飛球');
      else if(act==='foul') foul();
      else if(act==='grd') groundRuleDouble();
      else if(act==='hbp') hbp();
      else if(act==='wp') wp();
      else if(act==='err') errorHit();
      else if(act==='bunt') bunt();
      else if(act.startsWith('hit-')){ hit(parseInt(act.split('-')[1],10)); }
    });
  });

  el.btnLeftBat.addEventListener('click', ()=>{ state.stance='左打'; updateAll(); });
  el.btnRightBat.addEventListener('click',()=>{ state.stance='右打'; updateAll(); });

  el.btnEdit.addEventListener('click',()=>{
    state.edit_mode=!state.edit_mode;
    el.btnEdit.textContent=state.edit_mode?'完成':'編輯';
    updateAll();
  });

  // 編輯：分數 / PITCH 微調
  el.pPlus.addEventListener('click',()=>{ if(!state.edit_mode) return;
    pushHistory(); const def=currentDefense();
    state.pitch_team[def]=(state.pitch_team[def]||0)+1; updateAll(); });
  el.pMinus.addEventListener('click',()=>{ if(!state.edit_mode) return;
    pushHistory(); const def=currentDefense();
    state.pitch_team[def]=Math.max(0,(state.pitch_team[def]||0)-1); updateAll(); });

  el.sPlus.addEventListener('click',()=>{ if(!state.edit_mode) return;
    pushHistory(); const off=currentOffense();
    state.score[off]=(state.score[off]||0)+1; updateAll(); });
  el.sMinus.addEventListener('click',()=>{ if(!state.edit_mode) return;
    pushHistory(); const off=currentOffense();
    state.score[off]=Math.max(0, (state.score[off] || 0) - 1); updateAll(); });

  // 編輯：PA 手動調整（只動目前半局的陣列尾端；顯示的是整場累計）
  el.paPlus.addEventListener('click',()=>{ if(!state.edit_mode) return;
    pushHistory();
    currentHalfArray().push({
      summary:'X', stance:'X',
      scoreL: state.score[state.teamL]||0,
      scoreR: state.score[state.teamR]||0,
      manual:true
    });
    saveInnings(); updateAll();
  });
  el.paMinus.addEventListener('click',()=>{ if(!state.edit_mode) return;
    const arr=currentHalfArray(); if(arr.length===0) return;
    pushHistory();
    arr.pop(); saveInnings(); updateAll();
  });

  // 編輯：點壘包切換佔壘
  ;[document.getElementById('b1'),document.getElementById('b2'),document.getElementById('b3')].forEach((node,idx)=>{
    node.style.cursor='pointer';
    node.title='編輯模式：點擊切換佔壘';
    node.addEventListener('click',()=>{ if(!state.edit_mode) return;
      pushHistory(); state.bases[idx]=!state.bases[idx]; updateAll(); });
  });

  // 復原上一步
  el.btnUndo.addEventListener('click',()=>{ undoLast(); });

  // 匯出 CSV（逐球）
  el.btnExport.addEventListener('click', ()=>{
    const rows = [[
      '局數','先守隊伍名稱（投手）','先功隊伍名稱（打擊）','先功隊伍名稱（投手）','先守隊伍名稱（打擊）','比分'
    ]];
    state.logs.timeline.forEach(e=>{
      if(e.sep) return;
      const isTop = (e.half==='上');
      const col1 = isTop ? e.label : '';
      const col2 = isTop ? e.stance: '';
      const col3 = isTop ? ''       : e.label;
      const col4 = isTop ? ''       : e.stance;
      const scoreStr = `${e.scoreL}：${e.scoreR}`;
      rows.push([e.inning, col1, col2, col3, col4, scoreStr]);
    });
    const csv = rows.map(r => r.map(v => `"${String(v).replace(/"/g,'""')}"`).join(',')).join('\r\n');
    const blob = new Blob([csv], {type: 'text/csv;charset=utf-8;'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = `log_${new Date().toISOString().slice(0,10)}.csv`;
    document.body.appendChild(a); a.click(); document.body.removeChild(a);
  });

  // 設定頁
  el.btnReset.addEventListener('click', openSetup);
  el.btnSetupStart.addEventListener('click', ()=>{
    const off=(el.inTeamOff.value||'先攻隊伍').trim();
    const def=(el.inTeamDef.value||'先守隊伍').trim();
    state.teamL=off; state.teamR=def;
    state.inning=1; state.top=true; state.strike=0; state.ball=0; state.out=0;
    state.pitch_team[off]=0; state.pitch_team[def]=0;
    state.score[off]=0; state.score[def]=0;
    state.bases=[false,false,false]; state.game_over=false;
    state.logs={timeline:[]};
    state.innings=[{inning:1, top:[], bottom:[]}];
    saveInnings();
    closeSetup(); updateAll();
  });
  function openSetup(){ el.inTeamOff.value=state.teamL; el.inTeamDef.value=state.teamR; el.setup.classList.remove('hidden'); }
  function closeSetup(){ el.setup.classList.add('hidden'); }

  // 初始渲染
  updateAll();

  // PWA（GitHub Pages）
  if('serviceWorker' in navigator){
    window.addEventListener('load',()=>navigator.serviceWorker.register('service-worker.js'));
  }
})();
</script>
</body>
</html>
